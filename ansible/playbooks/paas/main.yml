---
- name: Configure the platform
  any_errors_fatal: true
  hosts: "{{ hosts_limit | default('infrastructure') }}"
  gather_facts: true
  become: true
  pre_tasks:

    - name: Set fqdn hostname
      ansible.builtin.hostname:
        name: "{{ inventory_hostname }}"
        use: systemd

    - name: Create ansible facts.d directory
      become: true
      ansible.builtin.file:
        path: /etc/ansible/facts.d
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Save Public IP as local fact
      when: fact_instance.location == 'frontends'
      block:
        - name: Get ipinfo.io (if backend instance, delegate_to the first frontend)
          ansible.builtin.uri:
            url: https://ipinfo.io
            http_agent: curl/7.81.0
          register: register_uri
          check_mode: false

        - name: Set ipinfo local_fact
          ansible.builtin.copy:
            content: |
              {{ register_uri.json | to_nice_json }}
            dest: /etc/ansible/facts.d/ipinfo.fact
            mode: '0644'

    - name: Install mandatories packages
      ansible.builtin.apt:
        pkg:
          - python3-debian
          - python3-venv
          - unzip
          - make
          - jq
          - dnsutils

        state: present
        install_recommends: false
      register: apt_status
      until: apt_status is success
      delay: 6
      retries: 10

  roles:
    - unattended-upgrades
    - ansible-ufw

- name: Configure sshd
  ansible.builtin.import_playbook: sshd.yml
- name: Configure timesyncd
  ansible.builtin.import_playbook: timesyncd.yml
- name: Configure systemd resolved
  ansible.builtin.import_playbook: systemd-resolved.yml
- name: Configure nvidia
  ansible.builtin.import_playbook: nvidia.yml
- name: Configure docker
  ansible.builtin.import_playbook: docker.yml
- name: Configure nomad
  ansible.builtin.import_playbook: nomad.yml
- name: Configure coredns
  ansible.builtin.import_playbook: coredns.yml
- name: Configure metrology
  ansible.builtin.import_playbook: metrology.yml
