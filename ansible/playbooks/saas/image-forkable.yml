---
- name: Build a Docker image from a catalog id
  hosts: "{{ hosts_limit | default('infrastructure') }}"
  become: true
  gather_facts: true
  vars_prompt:
    - name: catalog_id
      prompt: "Catalog item ID"
      private: false
  vars:
    architecture_map:
      amd64: amd64
      x86_64: amd64
      armv7l: arm
      aarch64: arm64
      arm64: arm64
    catalog: "{{ catalog_response.json.origin | default(catalog_response.json.name) }}"
    build_work_dir: "/tmp/{{ catalog }}"
    download_dir: "{{ build_work_dir }}/download"
    arch_dir: "{{ build_work_dir }}/{{ upstream_default_arch }}"
    upstream_default_arch: "{{ architecture_map[ansible_facts.architecture] }}"    
    ui_url: "{{ lookup('ansible.builtin.env', 'SIMPLE_STACK_UI_URL') }}"
    ui_user: "{{ lookup('ansible.builtin.env', 'SIMPLE_STACK_UI_USER') }}"
    ui_password: "{{ lookup('ansible.builtin.env', 'SIMPLE_STACK_UI_PASSWORD') }}"

  pre_tasks:
    - name: Retrieve catalog item from UI
      ansible.builtin.uri:
        url: "{{ ui_url }}/api"
        user: "{{ ui_user }}"
        password: "{{ ui_password }}"
        method: POST
        body_format: json
        body:
          schema: "catalogs_read/{{ catalog_id }}"
        force_basic_auth: true
        status_code: 200
      delegate_to: localhost
      register: catalog_response
      become: false

    - name: Ensure temporary build directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ download_dir }}"
        - "{{ arch_dir }}"

  tasks:
    - name: Build assets
      ansible.builtin.include_role:
        name: "{{ catalog }}"
        tasks_from: build
      vars:
        catalog_image_name: "{{ catalog_response.json.name }}"
        dockerfile_root: "{{ catalog_response.json.dockerfile_root | default('') }}"
        dockerfile_nonroot: "{{ catalog_response.json.dockerfile_nonroot | default('') }}"

    - name: Build and push Docker image
      community.docker.docker_image_build:
        name: "{{ docker_private_registry.url }}/{% if docker_private_registry.project is defined %}{{ docker_private_registry.project }}/{% endif %}{{ catalog_response.json.name }}:{{ image_version }}"
        tag: latest
        path: "{{ build_work_dir }}"
        dockerfile: Dockerfile
        labels: "{{ image_definition.labels | default({}) }}"
        rebuild: always
        outputs:
          - type: image
            push: true
      register: docker_build
      when: image_definition.build
      notify: Cleanup build directory

    - name: Update catalog item version on UI
      ansible.builtin.uri:
        url: "{{ ui_url }}/api"
        user: "{{ ui_user }}"
        password: "{{ ui_password }}"
        method: POST
        body_format: json
        body:
          schema: catalogs_create
          data:
            name: "{{ catalog_response.json.name }}"
            version: "{{ image_version }}"
            forkable: "{{ image_forkable | default(false) }}"
        force_basic_auth: true
        status_code: 200
      delegate_to: localhost
      register: ui_update
      failed_when: ui_update.status != 200
      become: false

  handlers:
    - name: Cleanup build directory
      ansible.builtin.file:
        path: "{{ build_work_dir }}"
        state: absent
      listen: cleanup_build

  post_tasks:
    - name: Trigger cleanup on failure
      ansible.builtin.meta: clear_host_errors
      when: ansible_failed_result is defined
      notify: Cleanup build directory
