<style>
	.CLASS figure { /*border-top: 1px solid #e0e0e02e;*/ font-size: 14px; margin-top: 20px; margin-bottom: 20px;}
	.CLASS figure:first-child { border-top: 0; }
	.CLASS figure:first-child { margin-top: 0; }
	.CLASS .buttons { float: right; padding-left: 10px; }
	.CLASS .name { margin-right: 300px; }
	.CLASS .name > i { width: 12px; margin-right: 5px; text-align: center; }
	.CLASS .buttons span { line-height: 21px; margin:0px 2px 2px 2px ; border-radius: var(--radius); border: 0; margin: 0 5px; }
	.CLASS figure .name .picto { display: inline-block; padding-right: 15px; }
	.ui-box-icon { color: #EA706B }

	@media(max-width:768px) {
		.CLASS .name { margin-right: 46px; }
	}
</style>

<ui-component name="box" path="common.form" config="if:~PATH~;width:620;icon:ti ti-folders;title:@(Catalog);reload:?/reload;" class="hidden ~PATH~" plugin="~PATH~">
	<nav>
		<button class="exec" data-exec="?/settings"><i class="ti ti-config"></i>@(Settings)</button>
		<button class="exec" data-exec="?/fork"><i class="ti ti-code-branch green"></i>@(Fork)</button>
	</nav>
	<ui-component name="textbox" path="?.search" config="type:search"></ui-component>
	<ui-component name="searchdata" path="?.search" config="datasource:?.items;key:name;output:?.searchoutput">
		<div class="padding">
			<ui-bind path="?.searchoutput" config="track:id;template" class="meta listing">
				<script type="text/html">
				{{ foreach m in value }}
					<figure data-alias="{{ m.alias }}" data-id="{{ m.id }}" data-fork="{{ m.fork }}" class="exec items" data-exec="?/update">
						<section>
							<div class="buttons">
								<span class="gray fs11 ml5">{{ m.version | empty }}</span>
								<span class="exec"><span class="badge badge-small badge-green">{{ if m.fork }}<i class="ti ti-code-branch green">{{ else }}<i class="ti ti-code-branch grey"></i>{{ fi }}</i></span></span>
								<span class="exec"><span class="badge badge-small badge-green">{{ if m.cron }}<i class="ti ti-clock orange">{{ else }}<i class="ti ti-clock grey"></i>{{ fi }}</i></span></span>
								<span class="exec" data-exec="?/execute" data-prevent="true"><i class="ti ti-play green"></i></span>
								<span class="exec version" data-exec="?/remove" data-prevent="true"><i class="ti ti-trash red"></i></span>
							</div>
							<div class="name">
								<div class="picto">
									<span><img src="/img/{{ m.picto | def(m.name) }}.png" width="15" heigth="15" /></span>
								</div>
								{{ m.alias | empty(m.name) }}
							</div>
						</section>
					</figure>
				{{ end }}
				</script>
			</ui-bind>
		</div>
	</ui-component>
</ui-component>

<script>
	PLUGIN(function(exports) {

		Thelpers.picto = function(val) {
			return '<div style="padding:0px;border:0px solid #E0E0E0"><img src="/img/{0}.png" width="15" heigth="15" top="0" border="0" /></div>'.format(val);
		};

		exports.reload = function() {
			exports.refresh();
		};

		exports.refresh = function() {
			exports.tapi('catalogs ERROR', function(result){
				var output = {
					search: '',
					searchoutput: [],
					items: result.items,
					settingsId: result.settingsId
				};
				exports.set(output);
				SET('catalog_list', result.items);
			});
		};

		exports.fork = function() {
			const catalog_list = GET('catalog_list').filter(item => Boolean(item?.forkable));
			SET('formcatalogfork @default', { tab: 'default', catalog_list: catalog_list, crontab: '* * * * *'});
			SET('common.form2', 'formcatalogfork');
		};

		exports.settings = function(el) {
			const id = GET('?.settingsId');
			const type = 'settings';
			const key = 'catalogs';

			if(!id){
				SET('formvariable @reset @hideloading', { type: type, key: key });
				SET('common.form2', 'formvariable');
			}
			else {
				exports.tapi('variables_read/{0} ERROR'.format(id), { type: type, format: 'yaml', key: key}, function(response) {
					SET('formvariable @reset @hideloading', response);
					SET('common.form2', 'formvariable');
				});
			}
		};

		exports.remove = function(el) {
			var id = ATTRD(el);
			var alias = ATTRD(el, 'alias');
			SETTER('approve/show', '@(Remove {0}?)'.format(alias), '"ti ti-trash" @(Remove)', function() {
				exports.tapi('catalogs_remove/{0} ERROR'.format(id),function() {
					SETTER('notify/success', '@(Done)');
					CLRELOAD('cl');
					exports.refresh();
				});
			});
		};

		exports.update = function(el) {
			var id = ATTRD(el);
			var fork = ATTRD(el, 'fork');
			exports.tapi('catalogs_read/{0} ERROR'.format(id), function(response) {
				if(fork){
					response.tab = 'default';
					response.catalog_list = GET('catalog_list').filter(item => Boolean(item?.forkable));
					
					SET('formcatalogfork @reset @hideloading', response);
					SET('common.form2', 'formcatalogfork');
				}
				else {
					SET('formcatalog @reset @hideloading', response);
					SET('common.form2', 'formcatalog');
				}
			});
		};

		exports.execute = function(el) {
			var id = ATTRD(el);
			var alias = ATTRD(el, 'alias');
			SETTER('approve/show', '@(Build {0}?)'.format(alias), '"ti ti-play" @(Execute)', function() {
				exports.tapi('catalogs_execute/{0} ERROR'.format(id),function() {
					SETTER('notify/success', '@(Done)');
				});
			});
		};
	});
</script>