<style>
	.CLASS figure { /*border-top: 1px solid #e0e0e02e;*/ font-size: 14px; margin-top: 20px; margin-bottom: 20px;}
	.CLASS figure:first-child { border-top: 0; }
	.CLASS figure:first-child { margin-top: 0; }
	.CLASS .buttons { float: right; padding-left: 10px; }
	.CLASS .name { margin-right: 100px; }
	.CLASS .name > i { width: 12px; margin-right: 5px; text-align: center; }
	.CLASS figure .name .description { margin-left: 9px; }
	.CLASS .buttons span { line-height: 21px; margin:0px 2px 2px 2px ; border-radius: var(--radius); border: 0; margin: 0 5px; }
	.CLASS figure .name .picto { display: inline-block; padding-right: 15px; }
	.CLASS figure .name .badges { display: inline-block; border-left: 1px solid #e0e0e0; padding-left: 15px; }
	.ui-box-icon { color: #EA706B }

	@media(max-width:768px) {
		.CLASS .name { margin-right: 46px; }
	}
</style>

<ui-component name="box" path="common.form" config="if:~PATH~;width:600;icon:ti ti-sitemap;title:@(Infrastructures);reload:?/reload;hide:?/close;;close:?/close" class="hidden ~PATH~" plugin="~PATH~">
	<nav>
		<button class="exec" data-exec="?/settings"><i class="ti ti-config"></i></button>
		<button class="exec" data-exec="?/add"><i class="ti ti-plus-circle green"></i>@(Add)</button>
		<button class="exec" data-exec="?/events"><i class="ti ti-comment purple"></i></button>
		<button class="exec" data-exec="?/operations" data-bind="?__enabled:value&&(value.checked&&value.checked.length)__track:checked" disabled><i class="fa fa-check-circle"></i>@(Operate)</button>
	</nav>
	<ui-component name="empty" path="?.items" config="parent:auto;icon:ti ti-frown red">
		<script type="text/html">
			@(You don't have any infrastructures here)
		</script>
		
		<ui-component name="datagrid" path="?.items" config="height:fluid;minheight:fluid;numbering:false;sorting:true;dblclick:?/update;button:?/button;checked:?.checked;">
			<script type="text/plain">
				[
				{ name: 'name', text: 'Name', template:'<span><i class="{{ icon }}" style="color:{{ color }}"></i></span>&nbsp;&nbsp;&nbsp;{{ name }}', width: 350 },
				]
			</script>
		</ui-component>
		<ui-component name="console2" path="?.console_visible" config="autoshow:false;clear:?/clear_events;datasource:?.console_logs"></ui-component>
	</ui-component>

</ui-component>

<script>
	PLUGIN(function(exports) {

		var interval = '';

		exports.reload = function() {
			exports.refresh();
		};

		exports.refresh = function() {
			exports.tapi('infrastructures ERROR', function(results){
				exports.set(results);
			});
		};
		
		exports.refreshGraph = function() {
			REDIRECT('/ @showloading @hideloading');
		};

		exports.add = function() {
			SET('forminfrastructure @default', {});
			SET('common.form2', 'forminfrastructure');
		};

		exports.settings = function(el) {
			const id = GET('?.settingsId');
			console.log(id);
			const type = 'settings';
			const key = 'infrastructures';

			if(!id){
				SET('formvariable @reset @hideloading', { type: type, key: key });
				SET('common.form2', 'formvariable');
			}
			else {
				exports.tapi('variables_read/{0} ERROR'.format(id), { type: type, format: 'yaml', key: key}, function(response) {
					SET('formvariable @reset @hideloading', response);
					SET('common.form2', 'formvariable');
				});
			}
		};

		exports.update = function(el) {
			var id = ATTRD(el);
			exports.tapi('infrastructures_read/{0} ERROR'.format(id), function(response) {
				SET('forminfrastructure @reset @hideloading', response);
				SET('common.form2', 'forminfrastructure');
			});
		};

		exports.refresh_events = function(el) {
			exports.tapi('events_read ERROR', function(result){
				SET('?.console_logs', result);
			});
		};

		exports.events = function(el) {
			SET('?.console_visible', true);
			exports.refresh_events();
			interval = setInterval(function() {
				exports.refresh_events();
            }, 10000);
		};

		exports.close = function() {
            clearInterval(interval);
		};

		exports.clear_events = function(el) {
			clearInterval(interval);
			exports.tapi('events_remove ERROR', function(){
				SET('?.console_visible', false);
			});
		};

		exports.operations = function(el) {

			var model = GET('?');
			var options = {};
			options.align = 'center';
			options.items = [];
			options.element = el;
			var icon = ATTRD(el, 'icon');

			options.items.push({ action: 'main', path: 'execute', name: 'Run all playbooks', icon: 'ti ti-play green', comment: '@(Do you want to run all playbook ?)'});
			options.items.push('-');
			options.items.push({ action: 'docker', path: 'execute', name: 'docker', icon: 'ti ti-play', comment: '@(Do you want to run docker playbook ?)'});
			options.items.push({ action: 'nomad', path: 'execute', name: 'nomad', icon: 'ti ti-play', comment: '@(Do you want to run nomad playbook ?)'});
			options.items.push({ action: 'coredns', path: 'execute', name: 'coredns', icon: 'ti ti-play', comment: '@(Do you want to run coredns playbook ?)'});
			options.items.push({ action: 'firewall', path: 'execute', name: 'firewall', icon: 'ti ti-play', comment: '@(Do you want to run firewall playbook ?)'});
			options.items.push({ action: 'metrology', path: 'execute', name: 'metrology', icon: 'ti ti-play', comment: '@(Do you want to run metrology playbook ?)'});
			options.items.push('-');
			options.items.push({ action: 'nomad-clean-errors', path: 'execute', name: 'Clean nomad errors', icon: 'ti ti-play orange', comment: '@(Do you want to clean nomad errors ?)'});
			options.items.push('-');
			options.items.push({ action: 'remove', path: 'remove',  name: 'Remove', icon: 'ti ti-trash red', comment: '@(Remove selected infrastructures ?)'});

			options.callback = function(item) {
				SETTER('approve/show', item.comment, '"{0}"'.format(item.icon), function() {
					model.checked.wait(function(value, next) {
						exports.tapi('infrastructures_{0}/{1} ERROR'.format(item.path, value.id), { action: item.action }, function(result) {
							next();
						});
					}, function(){
						SETTER('notify/success', '@(Done)');
					});
				});
			};
			SETTER('menu', 'show', options);
		};
	});
</script>